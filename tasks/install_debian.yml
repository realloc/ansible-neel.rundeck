---
# Debian based OS
- name: Rundeck | Install supporting packages
  apt:
    name: "{{ item }}"
    state: present
  become: yes
  with_items:
    - python-pip

- name: Rundeck | Install supporting python packages
  pip:
    name: "{{ item }}"
    state: present
  become: yes
  with_items:
    - httplib2

- name: Rundeck | Add Bintray GPG key for rundeck repo
  apt_key:
    id: 379CE192D401AB61
    url: https://bintray.com/user/downloadSubjectPublicKey?username=bintray
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | Add Rundeck Build GPG key
  apt_key:
    id: 85E9DBC74FCB329EDEDADD2E90770E1BE2D1065B
    url: http://rundeck.org/keys/BUILD-GPG-KEY-Rundeck.org.key
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | Add Rundeck APT repository on Bintray
  apt_repository:
    repo: 'deb https://dl.bintray.com/rundeck/rundeck-deb /'
    filename: rundeck
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | install from APT repository
  apt:
    name: "rundeck={{ rundeck_version }}"
    state: present
  notify:
    - systemd daemon-reload
    - start rundeck
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | install CLI tools from APT repository
  apt:
    name: rundeck-cli
    state: present
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | Check rundeck user default shell
  user:
    name: rundeck
    shell: /bin/bash
  notify:
    - restart rundeck

- name: Rundeck | check upstart configuration exists
  register: upstart_config
  stat:
    path: /etc/init/rundeckd.conf
    get_md5: no
    get_checksum: no
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | remove System V init.d script if upstart config exists
  file:
    path: /etc/init.d/rundeckd
    state: absent
  when: upstart_config.stat.exists
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | replace profile helper
  copy:
    src: systemd/profile
    dest: /etc/rundeck/profile
    owner: rundeck
    group: rundeck
    mode: 0640
  when: ansible_service_mgr == 'systemd'
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | add systemd service helper
  copy:
    src: systemd/rundeck-start
    dest: /usr/bin/rundeck-start
    owner: root
    group: root
    mode: 0755
  when: ansible_service_mgr == 'systemd'
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | add systemd service unit
  copy:
    src: systemd/rundeckd.service
    dest: /etc/systemd/system/rundeckd.service
    owner: root
    group: root
    mode: 0644
  when: ansible_service_mgr == 'systemd'
  notify:
    - systemd daemon-reload
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | add systemd service unit symlink
  file:
    src: /etc/systemd/system/rundeckd.service
    dest: /etc/systemd/system/multi-user.target.wants/rundeckd.service
    state: link

- name: Rundeck | ensure service log directory has correct ownership
  file:
    path: /var/log/rundeck
    owner: rundeck
    state: directory
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | See if there are more log files
  find:
    paths: /var/log/rundeck
    file_type: file
    patterns: "*.log"
  register: rundeck_logfiles
  tags:
    - rundeck
    - install
    - packages

- name: Rundeck | ensure service log files have correct ownership
  file:
    path: "{{ item.path }}"
    owner: rundeck
    state: file
  with_items:
    "{{ rundeck_logfiles.files }}"
  tags:
    - rundeck
    - install
    - packages
